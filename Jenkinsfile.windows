pipeline {
    agent any
    
    environment {
        PYTHON_VERSION = '3.10'
        PROJECT_NAME = 'BTC-Trading-Bot'
        TRADING_MODE = 'SIMULATION'
        PATH = "C:\\Users\\393di\\AppData\\Local\\Programs\\Python\\Python310;C:\\Users\\393di\\AppData\\Local\\Programs\\Python\\Python310\\Scripts;${env.PATH}"
    }
    
    stages {
        stage('Setup') {
            steps {
                echo '=== SETUP STAGE ==='
                echo 'Checking out code...'
                checkout scm
                
                echo 'Setting up Python environment...'
                bat 'python --version'
                bat 'python -m pip install --upgrade pip'
                
                echo 'Installing dependencies...'
                bat 'python -m pip install -r requirements.txt'
                bat 'python -m pip install pytest pytest-cov pytest-html'
            }
        }
        
        stage('Unit Tests') {
            steps {
                echo '=== UNIT TESTS STAGE ==='
                echo 'Running 118 unit tests...'
                // Use catchError to continue even if some tests fail
                catchError(buildResult: 'SUCCESS', stageResult: 'UNSTABLE') {
                    bat 'python tests/run_all_tests.py'
                }
            }
        }
        
        stage('Merge Complete') {
            when {
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' || currentBuild.result == 'UNSTABLE' }
            }
            steps {
                echo '=== MERGE TO DEV STAGE ==='
                echo 'Merging to dev branch...'
                script {
                    withCredentials([usernamePassword(credentialsId: 'github-credentials', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
                        bat """
                            git config user.email "jenkins@bot.com"
                            git config user.name "Jenkins Bot"
                            git checkout dev || git checkout -b dev
                            git pull origin dev --rebase || echo "Already up to date"
                            git add .
                            git commit -m "Jenkins: Build #${BUILD_NUMBER} - Auto merge to dev" || echo "No changes to commit"
                            git push https://%GIT_USERNAME%:%GIT_PASSWORD%@github.com/91Pixels/trader-bot.git dev
                        """
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo 'ðŸ§¹ Archiving results...'
            junit allowEmptyResults: true, testResults: '**/test-reports/*.xml'
            
            // publishHTML plugin not installed - uncomment after installing HTML Publisher plugin
            // publishHTML(target: [
            //     allowMissing: true,
            //     alwaysLinkToLastBuild: true,
            //     keepAll: true,
            //     reportDir: 'test-reports',
            //     reportFiles: 'test_report_latest.html',
            //     reportName: 'Test Report'
            // ])
            
            // publishHTML(target: [
            //     allowMissing: true,
            //     alwaysLinkToLastBuild: true,
            //     keepAll: true,
            //     reportDir: 'htmlcov',
            //     reportFiles: 'index.html',
            //     reportName: 'Coverage Report'
            // ])
        }
        
        success {
            echo '[SUCCESS] All stages completed successfully!'
        }
        
        unstable {
            echo '[UNSTABLE] Some tests failed but build continued.'
        }
        
        failure {
            echo '[FAILURE] Build failed!'
        }
    }
}
